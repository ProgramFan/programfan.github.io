<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Prevent GCC from optimizing away a snippet of code</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="Jekyll v2.5.3">
  <link rel="alternate" type="application/rss+xml" title="Jekyll • Simple, blog-aware, static sites - Feed" href="/feed.xml">
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Jekyll’s master branch" href="https://github.com/ProgramFan/commits/master.atom">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->
</head>


<body class="wrap">
  <header role="banner">
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="current">
    <a href="/posts/">Posts</a>
  </li>
  <li>
    <a href="https://github.com/ProgramFan"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

  </nav>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <h1>
        <a href="/">
          <span class="sr-only">Jekyll</span>
          <img src="/img/logo-2x.png" width="249" height="115" alt="Jekyll Logo">
        </a>
      </h1>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="current">
    <a href="/posts/">Posts</a>
  </li>
  <li>
    <a href="https://github.com/ProgramFan"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

    </nav>
  </div>
</header>


    <section class="news">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the blog…</option>
    <option value="/news/">Home</option>
    <optgroup label="v1.x">
      
      <option value="/post/2015/05/05/using-rvm-to-isolate-rubygems-on-fedora-21/">Using RVM to Isolate RubyGems on Fedora 21</option>
      
      <option value="/post/2015/05/01/fix-boost-python-argument-error-lvalue/">Fix Argument Error with lvalue In Boost.Python</option>
      
      <option value="/post/2015/04/20/convert-chinese-asciidoc-to-pdf/">Convert Chinese Asciidoc Documents to PDF</option>
      
      <option value="/post/2015/01/20/prevent-gcc-optimize-away-code/">Prevent GCC from optimizing away a snippet of code</option>
      
    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        <article>
  <h2>
    Prevent GCC from optimizing away a snippet of code
    <a href="/post/2015/01/20/prevent-gcc-optimize-away-code/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      c++, gcc, and featured
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      20 Jan 2015
    </span>
    <a href="https://github.com/ProgramFan" class="post-author">
      <!-- <img src="https://github.com/ProgramFan.png" class="avatar" alt="ProgramFan avatar" width="24" height="24"> -->
      ProgramFan
    </a>
  </div>
  <div class="post-content">
    <div class="paragraph">
<p>Nowadays compilers are extremely capable of elimiting 'dead' code. But in
benchmarking we need some seemingly 'useless' code to do the work we want. For
example, to do computation in registers in order to measure instruction
latency and throughput. In these cases, we need a mechanism to temporarily
disable optimization.</p>
</div>
<div class="paragraph">
<p>This document keep an up-to-date collections of techniques to temporarily
disable compiler optimizations. These techniques are tested on a recent gcc or
icc compiler.</p>
</div>
<div class="sect1">
<h2 id="using-volatile">Using volatile</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>volatile</code> makes compilers be extremely careful (or conservative) on memory
load and store of a variable. Most compilers tend to do no optimizations at
all (even for proven dead code). So the <code>volatile</code> technique becomes the top 1
used.</p>
</div>
<!-- more -->
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span style="color: #B00040">void</span> <span style="color: #0000FF">doTest</span>() {
    <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">int</span> a <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    a <span style="color: #666666">+=</span> <span style="color: #666666">1</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>g++ -std=c++98 -O2</code> compiles the above code down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">movl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x0</span>,<span style="color: #666666">-0x4</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">mov</span>    <span style="color: #666666">-0x4</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>),<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">add</span>    <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x1</span>,<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">mov</span>    <span style="color: #666666">%</span><span style="color: #008000">eax</span>,<span style="color: #666666">-0x4</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
<div class="highlight"><pre><code class="language-asm" data-lang="asm"><span class="nf">movl</span>   <span class="no">$0x0</span><span class="p">,-</span><span class="mi">0x4</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
<span class="nf">mov</span>    <span class="p">-</span><span class="mi">0x4</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%eax</span>
<span class="nf">add</span>    <span class="no">$0x1</span><span class="p">,</span><span class="nv">%eax</span>
<span class="nf">mov</span>    <span class="nv">%eax</span><span class="p">,-</span><span class="mi">0x4</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
<span class="nf">retq</span></code></pre></div>
<div class="paragraph">
<p><code>icpc -std=c++98 -O2</code> compiles it down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">movl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x0</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">incl</span>   <span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="empty-assembly">Empty assembly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another current weakness of compilers is that they are careful with inline
assembly. Some version of gcc and icc tends to leave inline assembly touched
variable intact. This becomes the second technique to prevent optimizations.</p>
</div>
<div class="paragraph">
<p>For example, Facebook&#8217;s <a href="http://github.com/facebook/folly">Folly</a> library uses
the following <code>doNotOptimizeAway</code> function to prevent optimizing an
expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span style="color: #008000; font-weight: bold">template</span> <span style="color: #666666">&lt;</span><span style="color: #008000; font-weight: bold">typename</span> T<span style="color: #666666">&gt;</span> <span style="color: #008000; font-weight: bold">inline</span> doNotOptimizeAway(T<span style="color: #666666">&amp;&amp;</span> datum) {
    <span style="color: #008000; font-weight: bold">asm</span> <span style="color: #008000; font-weight: bold">volatile</span> (<span style="color: #BA2121">&quot;&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;+r&quot;</span> datum);
}
<span style="color: #B00040">void</span> doTest() {
    <span style="color: #B00040">int</span> a;
    doNotOptimizeAway(a <span style="color: #666666">=</span> <span style="color: #666666">0</span>);
    doNotOptimizeAway(a <span style="color: #666666">+=</span> <span style="color: #666666">16</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>icpc -std=c++11 -O2</code> compiles the above down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">movl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x0</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">mov</span>    <span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>),<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">mov</span>    <span style="color: #666666">%</span><span style="color: #008000">eax</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">addl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x10</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">mov</span>    <span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>),<span style="color: #666666">%</span><span style="color: #008000">edx</span>
<span style="color: #0000FF">mov</span>    <span style="color: #666666">%</span><span style="color: #008000">edx</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">incl</span>   <span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">mov</span>    <span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>),<span style="color: #666666">%</span><span style="color: #008000">ecx</span>
<span style="color: #0000FF">mov</span>    <span style="color: #666666">%</span><span style="color: #008000">ecx</span>,<span style="color: #666666">-0x8</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>g++ -std=c++11 -O2</code> compiles straightly down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">xor</span>    <span style="color: #666666">%</span><span style="color: #008000">eax</span>,<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">add</span>    <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x10</span>,<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>+r</code> modifier and the volatile modifier in the assembly is
essential. <code>+r</code> means the <code>datum</code> is both read from and write to by the
assembly, so compiler can not optimized it out. <code>volatile</code> stops the compiler
from removing the empty assembly. If you try <code>=r</code> instead of <code>+r</code>, gcc will
optimize it away but icc will keep it.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compiler-specific-pragma">Compiler specific pragma</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compilers provides ways to control their optimizer. gcc provides <code>pragma GCC</code> as a way to control temporarily the compiler behavior. By using <code>pragma GCC optimize("O0")</code>, the optimization level can be set to zero, which means absolutely no optimize for gcc.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span style="color: #BC7A00">#pragma GCC push_options</span>
<span style="color: #BC7A00">#pragma GCC optimize(&quot;O0&quot;)</span>
<span style="color: #B00040">void</span> <span style="color: #0000FF">doTest</span>() {
    <span style="color: #B00040">int</span> a;  <i class="conum" data-value="1"></i><b>(1)</b>
    a <span style="color: #666666">=</span> <span style="color: #666666">15</span>;
    a <span style="color: #666666">+=</span> <span style="color: #666666">1</span>;
}
<span style="color: #BC7A00">#pragma GCC pop_options</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a callout.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>g++ -std=c++98 -O2</code> compiles it straight forwardly down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">movl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0xf</span>,<span style="color: #666666">-0x4</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">addl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x1</span>,<span style="color: #666666">-0x4</span>(<span style="color: #666666">%</span><span style="color: #008000">rsp</span>)
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>icpc -std=c++98 -O2</code> compiles it down to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asm"><span style="color: #0000FF">sub</span>    <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x10</span>,<span style="color: #666666">%</span><span style="color: #008000">rsp</span>
<span style="color: #0000FF">movl</span>   <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0xf</span>,<span style="color: #666666">-0x10</span>(<span style="color: #666666">%</span><span style="color: #008000">rbp</span>)
<span style="color: #0000FF">mov</span>    <span style="color: #008000; font-weight: bold">$</span><span style="color: #666666">0x1</span>,<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">add</span>    <span style="color: #666666">-0x10</span>(<span style="color: #666666">%</span><span style="color: #008000">rbp</span>),<span style="color: #666666">%</span><span style="color: #008000">eax</span>
<span style="color: #0000FF">mov</span>    <span style="color: #666666">%</span><span style="color: #008000">eax</span>,<span style="color: #666666">-0x10</span>(<span style="color: #666666">%</span><span style="color: #008000">rbp</span>)
<span style="color: #0000FF">leaveq</span>
<span style="color: #0000FF">retq</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Although icc does a strange transformation to the code, it leaves the code any
way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The above pragma can be replaced by function attribute
<code>__attribute__((optimize("O0")))</code>
</td>
</tr>
</table>
</div>
</div>
</div>
  </div>
</article>

      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <h4>Featured</h4>
    <ul>
        
        
        <li class="">
          <a href="/post/2015/05/05/using-rvm-to-isolate-rubygems-on-fedora-21/">Using RVM to Isolate RubyGems on Fedora 21</a>
        </li>
        
        
        
        
        
        
        
        <li class="current">
          <a href="/post/2015/01/20/prevent-gcc-optimize-away-code/">Prevent GCC from optimizing away a snippet of code</a>
        </li>
        
        
    </ul>
    <h4>Other Posts</h4>
    <ul>
        
        
        
        
        <li class="">
          <a href="/post/2015/05/01/fix-boost-python-argument-error-lvalue/">Fix Argument Error with lvalue In Boost.Python</a>
        </li>
        
        
        
        <li class="">
          <a href="/post/2015/04/20/convert-chinese-asciidoc-to-pdf/">Convert Chinese Asciidoc Documents to PDF</a>
        </li>
        
        
        
        
    </ul>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer role="contentinfo">
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>The contents of this website are &copy;&nbsp;
      2015 by Yang Zhang under the terms of the MIT License.</p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>
        Proudly hosted by
        <a href="https://github.com">
          <img src="/img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>


</body>
</html>
